name: iOS Build for ATT Testing

on:
  workflow_dispatch:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.6'
        channel: 'stable'
        
    - name: Flutter doctor
      run: flutter doctor -v
      
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      id: flutter-pub-cache
      with:
        path: |
          ~/.pub-cache
        key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-pub-
      
    - name: Install dependencies
      run: flutter pub get
      
    - name: Create .env file from secrets
      run: |
        echo "# Environment variables for iOS build" > .env
        echo "# These are loaded from GitHub Secrets" >> .env
        echo "# For ATT testing, APPSFLYER_DEV_KEY and APPSFLYER_APP_ID are recommended" >> .env
        echo "" >> .env
        
        [ -n "$OPENAI_API_KEY" ] && echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env || echo "# OPENAI_API_KEY=not_set" >> .env
        [ -n "$APPMETRICA_API_KEY" ] && echo "APPMETRICA_API_KEY=$APPMETRICA_API_KEY" >> .env || echo "# APPMETRICA_API_KEY=not_set" >> .env
        [ -n "$APPSFLYER_DEV_KEY" ] && echo "APPSFLYER_DEV_KEY=$APPSFLYER_DEV_KEY" >> .env || echo "# APPSFLYER_DEV_KEY=not_set" >> .env
        [ -n "$APPSFLYER_APP_ID" ] && echo "APPSFLYER_APP_ID=$APPSFLYER_APP_ID" >> .env || echo "# APPSFLYER_APP_ID=not_set" >> .env
        [ -n "$ADMOB_APPLICATION_ID" ] && echo "ADMOB_APPLICATION_ID=$ADMOB_APPLICATION_ID" >> .env || echo "# ADMOB_APPLICATION_ID=not_set" >> .env
        [ -n "$ADMOB_BANNER_AD_UNIT_ID" ] && echo "ADMOB_BANNER_AD_UNIT_ID=$ADMOB_BANNER_AD_UNIT_ID" >> .env || echo "# ADMOB_BANNER_AD_UNIT_ID=not_set" >> .env
        [ -n "$ADMOB_INTERSTITIAL_AD_UNIT_ID" ] && echo "ADMOB_INTERSTITIAL_AD_UNIT_ID=$ADMOB_INTERSTITIAL_AD_UNIT_ID" >> .env || echo "# ADMOB_INTERSTITIAL_AD_UNIT_ID=not_set" >> .env
        
        echo "âœ… .env file created"
        VARIABLES_SET=$(grep -c '^[A-Z_]*=' .env || echo 0)
        echo "ðŸ“‹ Environment variables set: $VARIABLES_SET/7"
        if [ "$VARIABLES_SET" -lt 2 ]; then
          echo "âš ï¸  Warning: APPSFLYER_DEV_KEY and APPSFLYER_APP_ID are recommended for ATT testing"
        fi
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}
        APPSFLYER_DEV_KEY: ${{ secrets.APPSFLYER_DEV_KEY }}
        APPSFLYER_APP_ID: ${{ secrets.APPSFLYER_APP_ID }}
        ADMOB_APPLICATION_ID: ${{ secrets.ADMOB_APPLICATION_ID }}
        ADMOB_BANNER_AD_UNIT_ID: ${{ secrets.ADMOB_BANNER_AD_UNIT_ID }}
        ADMOB_INTERSTITIAL_AD_UNIT_ID: ${{ secrets.ADMOB_INTERSTITIAL_AD_UNIT_ID }}
      
    - name: Cache CocoaPods
      uses: actions/cache@v4
      id: cocoapods-cache
      with:
        path: |
          ios/Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
      
    - name: Setup CocoaPods
      run: |
        sudo gem install cocoapods
        cd ios
        if [ -f Podfile.lock ] && [ -d Pods ]; then
          echo "âœ… Using cached CocoaPods, skipping repo update"
          pod install
        else
          echo "ðŸ“¦ Installing CocoaPods dependencies (first time or cache miss)"
          pod install --repo-update
        fi
        cd ..
        
    - name: Cache Flutter build artifacts
      uses: actions/cache@v4
      id: flutter-build-cache
      with:
        path: |
          build/ios
          .dart_tool/flutter_build
        key: ${{ runner.os }}-flutter-build-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('lib/**/*.dart') }}
        restore-keys: |
          ${{ runner.os }}-flutter-build-${{ hashFiles('**/pubspec.lock') }}-
          ${{ runner.os }}-flutter-build-
    
    - name: Cache iOS Xcode artifacts
      uses: actions/cache@v4
      id: xcode-build-cache
      with:
        path: |
          ios/build
          ios/.symlinks
          ios/Flutter/Flutter.framework
          ios/Flutter/Flutter.podspec
          ios/Flutter/Generated.xcconfig
          ios/Flutter/ephemeral
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-build-${{ hashFiles('ios/Podfile.lock') }}-${{ hashFiles('ios/Runner.xcodeproj/**') }}
        restore-keys: |
          ${{ runner.os }}-xcode-build-${{ hashFiles('ios/Podfile.lock') }}-
          ${{ runner.os }}-xcode-build-
      
    - name: Build iOS for simulator
      run: |
        FLUTTER_CACHE_HIT="${{ steps.flutter-build-cache.outputs.cache-hit }}"
        XCODE_CACHE_HIT="${{ steps.xcode-build-cache.outputs.cache-hit }}"
        
        if [ "$FLUTTER_CACHE_HIT" == "true" ] && [ "$XCODE_CACHE_HIT" == "true" ]; then
          echo "âœ… Using cached iOS build artifacts - full incremental build"
          echo "ðŸ“¦ Both Flutter and Xcode caches restored"
          echo "â±ï¸ Expected build time: 2-5 minutes (incremental)"
        elif [ "$FLUTTER_CACHE_HIT" == "true" ] || [ "$XCODE_CACHE_HIT" == "true" ]; then
          echo "âš ï¸ Partial cache hit - some artifacts will be rebuilt"
          echo "â±ï¸ Expected build time: 10-15 minutes (partial cache)"
        else
          echo "ðŸ“¦ Building iOS from scratch (cache miss)"
          echo "â±ï¸ This will take ~20-25 minutes on first build"
        fi
        flutter build ios --debug --simulator --no-codesign
        
    - name: Find and package .app bundle
      working-directory: ${{ github.workspace }}
      run: |
        echo "ðŸ” Searching for Runner.app..."
        APP_PATH=$(find build/ios -name "Runner.app" -type d 2>/dev/null | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "âš ï¸ Runner.app not found in build/ios, searching in all directories..."
          APP_PATH=$(find . -name "Runner.app" -type d -not -path "*/.*" 2>/dev/null | head -1)
        fi
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ Runner.app not found anywhere"
          echo "ðŸ“‹ Available .app files:"
          find . -name "*.app" -type d 2>/dev/null | head -10
          exit 1
        fi
        
        echo "âœ… Found Runner.app at: $APP_PATH"
        echo "ðŸ“¦ Creating ZIP archive..."
        cd "$(dirname "$APP_PATH")"
        zip -r "$GITHUB_WORKSPACE/Runner.app.zip" Runner.app
        cd "$GITHUB_WORKSPACE"
        
        if [ -f Runner.app.zip ]; then
          ZIP_SIZE=$(ls -lh Runner.app.zip | awk '{print $5}')
          echo "âœ… Runner.app.zip created successfully: $ZIP_SIZE"
          ls -lh Runner.app.zip
        else
          echo "âŒ Failed to create Runner.app.zip"
          exit 1
        fi
        
    - name: Upload iOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-bundle
        path: ${{ github.workspace }}/Runner.app.zip
        retention-days: 7
        if-no-files-found: error
        
    - name: Build summary
      if: always()
      run: |
        echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
        if [ -f Runner.app.zip ]; then
          echo "- âœ… Flutter dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CocoaPods installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS app built for simulator" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Artifact: Runner.app.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cache Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter pub cache: ${{ steps.flutter-pub-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "- CocoaPods cache: ${{ steps.cocoapods-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter build cache: ${{ steps.flutter-build-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode build cache: ${{ steps.xcode-build-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract Runner.app.zip" >> $GITHUB_STEP_SUMMARY
          echo "3. Upload Runner.app to Appetize.io or BrowserStack" >> $GITHUB_STEP_SUMMARY
          echo "4. Test ATT functionality on iOS simulator" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Build may have failed or was cancelled" >> $GITHUB_STEP_SUMMARY
          echo "- Check logs above for details" >> $GITHUB_STEP_SUMMARY
        fi
